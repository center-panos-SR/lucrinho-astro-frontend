---
import { fetchAPI } from '~/lib/api.js';
import ArticleCard from '../common/ArticleCard.astro';

// Buscar artigos do Strapi
const artigosStrapi = await fetchAPI('artigos?populate=*&pagination[limit]=10&sort=createdAt:desc');

// Dados mock fallback
const mockArticles = [
  {
    titulo: "Aposentadoria neste outono? Agora é a hora de abrir um CD",
    category: { name: "CD News" },
    createdAt: "2025-10-09",
    cover: { url: "/placeholder-article-1.jpg" },
    slug: "aposentadoria-cd",
  },
  {
    titulo: "O mercado de ações estará aberto no Dia de Colombo? Confira a programação dos feriados de outono e inverno",
    category: { name: "Markets News" },
    createdAt: "2025-10-09",
    cover: { url: "/placeholder-article-2.jpg" },
    slug: "mercado-colombo",
  },
  {
    titulo: "Mais cortes do Fed estão se aproximando — por que pode valer a pena pegar seu RMD de 2025 antes que eles aconteçam",
    category: { name: "Personal Finance News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-3.jpg" },
    slug: "fed-rmd",
  },
  {
    titulo: "Ganhos e perdas do S&P 500 hoje: alta impulsionada pela IA impulsiona índice para nova máxima",
    category: { name: "Markets News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-4.jpg" },
    slug: "sp500-ia",
  },
  {
    titulo: "As regras do Pell Grant mudaram. Um especialista explica como as famílias podem se preparar",
    category: { name: "Personal Finance News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-5.jpg" },
    slug: "pell-grant",
  },
  {
    titulo: "Perdas de empregos atingem duramente trabalhadores negros, asiáticos e hispânicos, gerando preocupações para todos os americanos",
    category: { name: "Economic News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-6.jpg" },
    slug: "perdas-empregos",
  },
  {
    titulo: "Principais ações em alta no momento: Nvidia, AMD, Dell, Fair Isaac e mais",
    category: { name: "Markets News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-7.jpg" },
    slug: "acoes-nvidia",
  },
  {
    titulo: "Ações da Rocket Lab sobem com novos acordos de lançamento de satélites multimissão",
    category: { name: "Tech Sector News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-8.jpg" },
    slug: "rocket-lab",
  },
  {
    titulo: "Este banco paga até 5,25% se você caminhar 10.000 passos por dia",
    category: { name: "Personal Finance News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-9.jpg" },
    slug: "banco-passos",
  },
  {
    titulo: "As inscrições abertas para o Medicare começam em 7 dias: informações essenciais e como se preparar",
    category: { name: "Insurance News" },
    createdAt: "2025-10-08",
    cover: { url: "/placeholder-article-10.jpg" },
    slug: "medicare-inscricoes",
  },
];

// Usar dados do Strapi se disponíveis, senão usar mock
const artigos = artigosStrapi.length > 0 ? artigosStrapi : mockArticles;

// Helpers
const getCategoryName = (category: any) => {
  return category?.name || "Notícias";
};

const getImageUrl = (cover: any) => {
  return cover?.url || "/placeholder-article-1.jpg";
};

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
};
---

<section class="latest-articles-section">
  <div class="container mx-auto px-4">
    <h2 class="latest-articles-title">Últimos artigos</h2>

    <div class="carousel-wrapper">
      <!-- Left Arrow -->
      <button
        class="carousel-button carousel-button-left"
        aria-label="Apresentar artigo anterior"
        id="carousel-prev"
      >
        <svg class="carousel-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <!-- Scrollable Container -->
      <div class="carousel-container" id="articles-carousel">
        {artigos.map((artigo) => (
          <ArticleCard
            title={artigo.titulo}
            category={getCategoryName(artigo.category)}
            date={formatDate(artigo.createdAt)}
            imageUrl={getImageUrl(artigo.cover)}
            href={`/artigo/${artigo.slug}`}
          />
        ))}
      </div>

      <!-- Right Arrow -->
      <button
        class="carousel-button carousel-button-right"
        aria-label="Apresentar o próximo artigo"
        id="carousel-next"
      >
        <svg class="carousel-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</section>

<style>
  .latest-articles-section {
    padding: 3rem 0;
    background: var(--color-background);
  }

  .latest-articles-title {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--color-foreground);
  }

  .carousel-wrapper {
    position: relative;
  }

  .carousel-wrapper:hover .carousel-button {
    opacity: 1;
  }

  .carousel-container {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding-bottom: 1rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .carousel-container::-webkit-scrollbar {
    display: none;
  }

  .carousel-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 50%;
    padding: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    color: var(--color-foreground);
  }

  .carousel-button:hover {
    background: var(--color-primary);
    color: var(--color-primary-foreground);
  }

  .carousel-button-left {
    left: 0;
    transform: translateY(-50%) translateX(-1rem);
  }

  .carousel-wrapper:hover .carousel-button-left {
    transform: translateY(-50%) translateX(0);
  }

  .carousel-button-right {
    right: 0;
    transform: translateY(-50%) translateX(1rem);
  }

  .carousel-wrapper:hover .carousel-button-right {
    transform: translateY(-50%) translateX(0);
  }

  .carousel-icon {
    width: 1.5rem;
    height: 1.5rem;
  }
</style>

<script>
  function initCarousel() {
    const container = document.getElementById('articles-carousel');
    const prevButton = document.getElementById('carousel-prev');
    const nextButton = document.getElementById('carousel-next');

    if (!container || !prevButton || !nextButton) return;

    const scrollAmount = 340;

    prevButton.addEventListener('click', () => {
      const newScrollLeft = container.scrollLeft - scrollAmount;
      container.scrollTo({
        left: newScrollLeft,
        behavior: 'smooth'
      });
    });

    nextButton.addEventListener('click', () => {
      const newScrollLeft = container.scrollLeft + scrollAmount;
      container.scrollTo({
        left: newScrollLeft,
        behavior: 'smooth'
      });
    });
  }

  // Inicializar ao carregar a página
  document.addEventListener('DOMContentLoaded', initCarousel);

  // Reinicializar após navegação do Astro (se usar View Transitions)
  document.addEventListener('astro:page-load', initCarousel);
</script>





